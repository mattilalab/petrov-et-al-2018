#!/bin/sh

# mastBestSort: create a CVS table of the best TF hits

# Copyright 2018 Petar Petrov (Turku, Finland)
# All rights reserved.
#
# Redistribution and use of this script, with or without modification, is
# permitted provided that the following conditions are met:
#
# 1. Redistributions of this script must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
#
#  THIS SOFTWARE IS PROVIDED BY THE AUTHOR "AS IS" AND ANY EXPRESS OR IMPLIED
#  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
#  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO
#  EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
#  SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
#  PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
#  OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
#  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
#  OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
#  ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

CWD=$(pwd)
TMP=${TMP:-/tmp/04_mastBestSort}

# List of regions and TFs expected to be found in each.
REGION=${REGION:-regionTF.txt}

# List of organisms to be arranged in the table
ORGANISM=${ORGANISM:-speciesSort.txt}

# MAST best hits, generated by mastOnly.
BEST=${BEST:-mastBest}

mkdir -p $TMP
cd $TMP

BYTF=byTF
FOUND=byFound
TABLE=tableSorted
REGOUT=regionsSorted
FINAL=tableFinal.csv
DUMMY=speciesList

rm -rf $BYTF $FOUND $TABLE $REGOUT $FINAL $DUMMY
mkdir -p $BYTF $FOUND $TABLE $REGOUT

 echo "" >> $DUMMY
 echo "" >> $DUMMY
 cat $CWD/$ORGANISM >> $DUMMY

while read tfname tfregion ; do
 while read organism ; do
  trfactor=$(grep "${organism}" $CWD/$BEST/${tfname}-region_${tfregion}.best | awk '{print $3 $4}')
  echo $organism $trfactor >> $BYTF/${tfregion}-${tfname}.txt
  sed "s|[^ ]*\\${tfname}[^ ]*|âœ“|gI" $BYTF/${tfregion}-${tfname}.txt > $FOUND/${tfregion}-${tfname}-check.txt
 done < $CWD/$ORGANISM
 check=$(awk '{print $2}' $FOUND/${tfregion}-${tfname}-check.txt)
 echo "$tfregion" >> $TABLE/$tfregion-$tfname.table.txt
 echo "$tfname" >> $TABLE/$tfregion-$tfname.table.txt
 echo "$check" >> $TABLE/$tfregion-$tfname.table.txt
 paste $TABLE/$tfregion-* > $REGOUT/$tfregion.list
 paste -d , $DUMMY $TABLE/*.txt > $FINAL
done < $CWD/$REGION
